---
description: Node.js å¾Œç«¯é–‹ç™¼è¦ç¯„ï¼ŒåŒ…å« APIã€éŒ¯èª¤è™•ç†å’Œå®‰å…¨æ€§æœ€ä½³å¯¦è¸
globs: backend/**/*.js
alwaysApply: false
---

# Node.js å¾Œç«¯é–‹ç™¼è¦ç¯„

## âœ… æ ¸å¿ƒåŸå‰‡

1. **æ‰€æœ‰ API endpoint å¿…é ˆåŒ…å«è³‡æ–™é©—è­‰**
2. **ä½¿ç”¨ async/await è™•ç†ç•°æ­¥æ“ä½œ**
3. **éŒ¯èª¤å¿…é ˆè¨˜éŒ„å®Œæ•´å †ç–Šè³‡è¨Š**
4. **æ•æ„Ÿè³‡è¨Šï¼ˆAPI keyã€tokenï¼‰ä½¿ç”¨ç’°å¢ƒè®Šæ•¸**

## ğŸ” è³‡æ–™é©—è­‰

### ä½¿ç”¨é©—è­‰å·¥å…·é¡

```javascript
// âŒ BAD - æ²’æœ‰é©—è­‰
router.post('/submit', async (req, res) => {
  const { taskId, userId, question, selectedNumbers } = req.body;
  const result = await processData(taskId, userId, question, selectedNumbers);
  res.json(result);
});

// âœ… GOOD - å®Œæ•´é©—è­‰
router.post('/submit', async (req, res, next) => {
  try {
    const { taskId, userId, question, selectedNumbers } = req.body;
    
    // ä½¿ç”¨é©—è­‰å·¥å…·
    Validator.validateTaskId(taskId);
    Validator.validateUserId(userId);
    Validator.validateQuestion(question);
    Validator.validateSelectedNumbers(selectedNumbers);
    
    const result = await processData(taskId, userId, question, selectedNumbers);
    res.json(result);
  } catch (error) {
    next(error); // å‚³éçµ¦éŒ¯èª¤è™•ç†ä¸­é–“ä»¶
  }
});
```

## âš ï¸ éŒ¯èª¤è™•ç†

### åˆ†å±¤éŒ¯èª¤è™•ç†

```javascript
// âœ… GOOD - æœå‹™å±¤æ‹‹å‡ºè©³ç´°éŒ¯èª¤
async function generateImage(question, pieces) {
  try {
    const canvas = createCanvas(5000, 5000);
    // ... åœ–ç‰‡ç”Ÿæˆé‚è¼¯
    return canvas.toBuffer('image/png');
  } catch (error) {
    logger.error('åœ–ç‰‡ç”Ÿæˆå¤±æ•—:', error);
    throw new Error('åœ–ç‰‡ç”Ÿæˆå¤±æ•—');
  }
}

// âœ… GOOD - è·¯ç”±å±¤è™•ç†éŒ¯èª¤
router.post('/submit', async (req, res, next) => {
  try {
    const imageBuffer = await generateImage(question, pieces);
    // ...
  } catch (error) {
    // å‚³éçµ¦å…¨åŸŸéŒ¯èª¤è™•ç†
    next(error);
  }
});

// âœ… GOOD - å…¨åŸŸéŒ¯èª¤è™•ç†è¿”å›å‹å–„è¨Šæ¯
function errorHandler(err, req, res, next) {
  logger.error('éŒ¯èª¤ç™¼ç”Ÿ:', {
    message: err.message,
    stack: err.stack,
    url: req.url
  });
  
  // ç”Ÿç”¢ç’°å¢ƒä¸æš´éœ²è©³ç´°éŒ¯èª¤
  const message = process.env.NODE_ENV === 'production' 
    ? 'ç³»çµ±æš«æ™‚ç„¡æ³•è™•ç†ï¼Œè«‹ç¨å¾Œå†è©¦'
    : err.message;
  
  res.status(err.statusCode || 500).json({
    error: err.name,
    message: message
  });
}
```

## ğŸ” å®‰å…¨æ€§

### ç’°å¢ƒè®Šæ•¸ç®¡ç†

```javascript
// âŒ BAD - ç¡¬ç·¨ç¢¼æ•æ„Ÿè³‡è¨Š
const client = new MessagingApiClient({
  channelAccessToken: 'YQANihoFPndvkey9J5aZvQgd...'
});

// âœ… GOOD - ä½¿ç”¨ç’°å¢ƒè®Šæ•¸
const client = new MessagingApiClient({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN
});

// âœ… GOOD - é©—è­‰ç’°å¢ƒè®Šæ•¸å­˜åœ¨
if (!process.env.LINE_CHANNEL_ACCESS_TOKEN) {
  throw new Error('LINE_CHANNEL_ACCESS_TOKEN ç’°å¢ƒè®Šæ•¸æœªè¨­å®š');
}
```

### Rate Limiting

```javascript
// âœ… GOOD - ä½¿ç”¨ express-rate-limit
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 60 * 1000, // 1 åˆ†é˜
  max: 10, // é™åˆ¶ 10 æ¬¡è«‹æ±‚
  message: {
    error: 'Too many requests',
    message: 'è«‹æ±‚éæ–¼é »ç¹ï¼Œè«‹ç¨å¾Œå†è©¦'
  }
});

app.use('/api/', limiter);
```

## ğŸ”„ ç•°æ­¥æ“ä½œ

### ä½¿ç”¨ async/await

```javascript
// âŒ BAD - å›èª¿åœ°ç„
function submitDivination(data, callback) {
  generateImage(data, (err, buffer) => {
    if (err) return callback(err);
    uploadImage(buffer, (err, url) => {
      if (err) return callback(err);
      updateSheets(data, (err) => {
        if (err) return callback(err);
        callback(null, url);
      });
    });
  });
}

// âœ… GOOD - async/await
async function submitDivination(data) {
  const imageBuffer = await generateImage(data);
  const imageUrl = await uploadImage(imageBuffer);
  
  // ä¸¦è¡Œè™•ç†
  await Promise.all([
    updateSheets(data),
    pushLineMessage(data.userId, imageUrl)
  ]);
  
  return imageUrl;
}
```

## ğŸ“Š æ—¥èªŒè¨˜éŒ„

### ä½¿ç”¨çµæ§‹åŒ–æ—¥èªŒ

```javascript
// âŒ BAD - ç°¡å–®çš„ console.log
console.log('User submitted:', userId);

// âœ… GOOD - çµæ§‹åŒ–æ—¥èªŒ
logger.info('ç”¨æˆ¶æäº¤æŠ½å¦', {
  taskId: data.taskId,
  userId: data.userId,
  questionLength: data.question.length,
  timestamp: new Date().toISOString()
});

// âœ… GOOD - éŒ¯èª¤æ—¥èªŒåŒ…å«å®Œæ•´è³‡è¨Š
logger.error('åœ–ç‰‡ä¸Šå‚³å¤±æ•—', {
  error: error.message,
  stack: error.stack,
  taskId: data.taskId,
  imageSize: buffer.length
});
```

## ğŸ”§ Google Sheets æ•´åˆ

### é€é n8n æ“ä½œ

```javascript
// âœ… GOOD - ä½¿ç”¨ n8n å®¢æˆ¶ç«¯
class N8nClient {
  async updateBoardUsage(taskId, positions) {
    try {
      const response = await axios.post(
        `${this.baseUrl}/webhook/update-board`,
        { taskId, positions },
        { timeout: 10000 }
      );
      
      return response.data;
    } catch (error) {
      logger.error('N8n æ›´æ–°å¤±æ•—:', error.message);
      throw new Error('Failed to update board usage');
    }
  }
}

// âŒ BAD - ç›´æ¥æ“ä½œ Google Sheets API
// ä¸è¦åœ¨å¾Œç«¯ç›´æ¥ä½¿ç”¨ Google Sheets APIï¼Œ
// æ‡‰è©²é€é n8n é€²è¡Œæ“ä½œ
```
